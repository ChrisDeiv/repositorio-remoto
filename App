from flask import Flask, request, jsonify, session, redirect, render_template_string
from db import crear_tablas, insertar_dato, obtener_datos, validar_usuario

app = Flask(__name__)
app.secret_key = "clave_super_secreta"

# Crear tablas al iniciar
crear_tablas()

# =======================
# HTML LOGIN
# =======================
LOGIN_HTML = """
<!DOCTYPE html>
<html>
<head>
<title>Login</title>
<style>
body{
    background: linear-gradient(135deg,#667eea,#764ba2);
    font-family: Arial, sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
}
.card{
    background:white;
    padding:30px;
    border-radius:10px;
    width:300px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
h2{
    text-align:center;
}
input{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:5px;
    border:1px solid #ccc;
}
button{
    width:100%;
    padding:10px;
    background:#667eea;
    border:none;
    color:white;
    font-weight:bold;
    border-radius:5px;
    cursor:pointer;
}
button:hover{
    background:#556cd6;
}
.error{
    color:red;
    text-align:center;
    margin-top:10px;
}
</style>
</head>
<body>

<div class="card">
<h2>Sensor Login</h2>
<form method="POST">
<input name="usuario" placeholder="Usuario" required>
<input type="password" name="password" placeholder="ContraseÃ±a" required>
<button type="submit">Entrar</button>
</form>
<div class="error">{{error}}</div>
</div>

</body>
</html>
"""

# =======================
# HTML DASHBOARD
# =======================
DASHBOARD_HTML = """
<!DOCTYPE html>
<html>
<head>
<title>Dashboard</title>
<style>
body{
    font-family: Arial;
    background:#f4f6f9;
    padding:20px;
}
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
h2{
    margin:0;
}
a{
    text-decoration:none;
    color:white;
    background:#e74c3c;
    padding:8px 12px;
    border-radius:5px;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
    background:white;
}
th, td{
    padding:10px;
    text-align:center;
}
th{
    background:#667eea;
    color:white;
}
tr:nth-child(even){
    background:#f2f2f2;
}
.footer{
    margin-top:10px;
    font-size:12px;
    color:#666;
}
</style>
</head>
<body>

<div class="header">
<h2>ðŸ“¡ Monitoreo de Temperatura y Humedad</h2>
<a href="/logout">Cerrar sesiÃ³n</a>
</div>

<table>
<tr>
<th>ID</th>
<th>Temperatura (Â°C)</th>
<th>Humedad (%)</th>
<th>Fecha</th>
</tr>
<tbody id="tabla"></tbody>
</table>

<div class="footer">
Mostrando las Ãºltimas 10 lecturas â€” actualizaciÃ³n automÃ¡tica cada 4 segundos
</div>

<script>
function cargar(){
 fetch("/data")
  .then(r => r.json())
  .then(data => {
    let html="";
    data.forEach(d=>{
      html += `<tr>
        <td>${d.id}</td>
        <td>${d.temperatura}</td>
        <td>${d.humedad}</td>
        <td>${d.fecha}</td>
      </tr>`;
    });
    document.getElementById("tabla").innerHTML = html;
  });
}
setInterval(cargar,4000);
cargar();
</script>

</body>
</html>
"""

# =======================
# RUTAS
# =======================
@app.route("/", methods=["GET","POST"])
def login():
    error = ""
    if request.method == "POST":
        if validar_usuario(request.form["usuario"], request.form["password"]):
            session["usuario"] = request.form["usuario"]
            return redirect("/dashboard")
        else:
            error = "Usuario o contraseÃ±a incorrectos"
    return render_template_string(LOGIN_HTML, error=error)

@app.route("/dashboard")
def dashboard():
    if "usuario" not in session:
        return redirect("/")
    return render_template_string(DASHBOARD_HTML)

@app.route("/api/data", methods=["POST"])
def api_data():
    data = request.get_json()
    if data and "temperatura" in data and "humedad" in data:
        insertar_dato(data["temperatura"], data["humedad"])
        return jsonify({"status":"OK"})
    return jsonify({"status":"ERROR"}), 400

@app.route("/data")
def data():
    return jsonify(obtener_datos())

@app.route("/logout")
def logout():
    session.clear()
    return redirect("/")

# =======================
# MAIN
# =======================
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
